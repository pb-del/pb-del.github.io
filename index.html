<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UCPM Test</title> 

<!-- OneTrust Cookies Consent Notice start for pb-del.github.io -->

    <script src="https://cdn.cookielaw.org/consent/01982ee7-bcee-74b1-ae28-35a3ab03e43b/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="01982ee7-bcee-74b1-ae28-35a3ab03e43b" ></script>
    <script type="text/javascript">
    function OptanonWrapper() {
        console.log("OneTrust SDK Initialized.");
        showConsentState(); // Display anonymous UUID and categories

        // Auto-refresh when user changes preferences
        window.addEventListener('consent.onConsentChanged', () => {
            console.log("Consent changed, refreshing state.");
            showConsentState();
        });
    }
    </script>
<!-- OneTrust Cookies Consent Notice end for pb-del.github.io -->

</head>

<body>
    <h1>UCPM Cross-Device Consent Demo - 2</h1>
    <p> This site demonstrates OneTrust + UCPM integration for both anonymous and authenticated users.</p>
    
    <button onclick="showConsentState()">Show Current Consent State</button>
    <button onclick="simulateLogin()">Simulate Login</button>
    <button onclick="dropTestCookie()">Drop Test Cookie</button>
    <button onclick="openPreferenceCenter()">Manage Preferences</button>

    <h2>Results</h2>
    <div id="results"><em> No data yet.</em></div>


    <script>
        const HARDCODED_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkiLCJuYW1lIjoiSm9obiBEb2UiLCJhZG1pbiI6dHJ1ZX0.19Z3GYWfOdh0cb6c4YRAe7GMpPZ6MnPlJTmWL3T0xeM";
        const user_id = "123456789"

        function updateResults(title, data) {
            const container = document.getElementById('results');
            container.innerHTML = `<h3>${title}</h3><pre>${JSON.stringify(data,null,2)}</pre>`;
        }

        function showConsentState() {
            const domainData = OneTrust.GetDomainData();
            const uuid = domainData?.Consent?.ConsentId || "Not available";

            updateResults("Current Consent State", {
                uuid,
                dataSubjectID: domainData?.Consent?.dataSubjectID || "Anonymous",
                groups: domainData?.Groups || [],
                timestamp: domainData?.Consent?.ConsentTimestamp || null
            });

            console.log("Consent State:", domainData);
        }
        // // Extract the OneTrust consent UUID from the OptanonConsent cookie
        // function getConsentUUID() {
        //     const cookie = document.cookie
        //     .split('; ')
        //     .find(row => row.startsWith('OptanonConsent='));
        //     if (!cookie) return null;

        //     // The OptanonConsent cookie is URL-encoded; parse out the consentID param
        //     const decoded = decodeURLcomponent(cookie);
        //     const match = decoded.match(/consentID=([^&]+)/);
        //     return match ? match[1] : null;
        // }

        // function getOptanonCookie() {
        //     const raw = document.cookie
        //     .split('; ')
        //     .find(row => row.startsWith('OptanonConsent='));
        //     return raw ?decodeURIComponent(raw) : "Not found";
        // }


        // function showUUID() {
        //     const uuid = getConsentUUID();
        //     const cookieVal = getOptanonCookie();
        //     updateResults("Anonymous UUID & OptanonConsentCookie", { uuid: uuid || "Not found" , cookie: cookieVal});
        //     console.log("UUID:", uuid, "OptanonConsent cookie:", cookieVal);
        // }

        // function showActiveGroups() {
        //     updateResults("Active Cookie Categories", { activeGroups: OptanonActiveGroups || "Not loaded"});
        //     console.log("Active Groups:", OptanonActiveGroups);
        // }
        // async function fetchUUIDPreferences() {
        //     const uuid = getConsentUUID();
        //     if(!uuid) {
        //         updateResults("Error", { message: "No OptanonConsent cookie found" });
        //     }

        //     const resp = await fetch('/api/fetch-preferences', {
        //         method: 'POST',
        //         headers: { 'Content-Type': 'application/json'},
        //         body: JSON.stringify({ uuid, token: HARDCODED_JWT})
        //     });
        //     const data = await resp.json();
        //     updateResults(`Preferences for UUID: ${uuid}`, data);
        // }

        // Simulate login: link the anonymous UUID to a fake user
        function simulateLogin() {
            const domainData = OneTrust.GetDomainData();
            const uuid = domainData?.Consent?.ConsentId || "Not available";

            console.log("Linking UUID", uuid, "to", user_id)

            OneTrust.SetDataSubjectID(user_id, { token: HARDCODED_JWT });
            OneTrust.UpdateConsent();      // Push link + consent to OneTrust
            OneTrust.SyncConsentProfile(); // pull updated profile back down

            setTimeout(() => {
                const updatedData = OneTrust.GetDomainData();
                updateResults("Linked Consent State", {
                    uuid: updatedData?.Consent?.ConsentId,
                    dataSubjectId: user_id,
                    groups: updatedData?.Groups || [],
                    timestamp: updatedData?.Consent?.ConsentTimestamp || null
            });
            }, 2000);
        }

         // example: only set a test cookie if user consented to Performance (C0002)
        function dropTestCookie() {
            const domainData = OneTrust.GetDomainData();
            const activeGroups = domainData?.Groups?.filter(g => g.IsActive).map(g =>GroupId) || [];

            if (activeGroups.includes('C0002')) {
                document.cookie ='test_cookie=allowed; path=/;';
                updateResults("Test Cookie", { status: "Set (Performance consent granted)" });
                console.log("Test cookie set");
            } else {
                updateResults("Test Cookie", { status: "Blocked (no Performance consent granted)" });
                console.log("Test cookie blocked");
            }
        }

        // Open the OneTrust preference center
        function openPreferenceCenter() {
            if (typeof OneTrust != 'undefined') {
                OneTrust.ToggleInfoDisplay();
            } else {
                alert("OneTrust not loaded yet.")
            }
        }
    </script>
</body>
</html>