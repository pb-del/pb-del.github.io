<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UCPM Test</title> 

    <!-- OneTrust Cookies Consent Notice start for pb-del.github.io -->
    <script src="https://cdn.cookielaw.org/consent/01982ee7-bcee-74b1-ae28-35a3ab03e43b/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="01982ee7-bcee-74b1-ae28-35a3ab03e43b-test" ></script>
    <script type="text/javascript">
        function OptanonWrapper() {
            console.log("OneTrust Loaded. Active consent groups:", OptanonActiveGroups)
        }
    </script>
    <!-- OneTrust Cookies Consent Notice end for pb-del.github.io -->
</head>

<body>
    <h1>UCPM Cross-Device Consent Demo</h1>
    <p> This site demonstrates OneTrust + UCPM integration for both anonymous and authenticated users.</p>
    
    <button onclick="showUUID()">Show Anonymous UUID</button>
    <button onclick="fetchUUIDPreferences()">Fetch Preferences for UUID</button>
    <button onclick="dropTestCookie()">Drop Test Cookie</button>
    <button onclick="simulateLogin()">Simulate Login</button>
    <button onclick="openPreferenceCenter()">Manage Preferences</button>"

    <h2>Results</h2>
    <div id="results"><em> No data yet.</em></div>


    <script>
        const HARDCODED_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkiLCJuYW1lIjoiSm9obiBEb2UiLCJhZG1pbiI6dHJ1ZX0.19Z3GYWfOdh0cb6c4YRAe7GMpPZ6MnPlJTmWL3T0xeM";
        const user_id = "123456789"

        // Extract the OneTrust consent UUID from the OptanonConsent cookie
        function getConsentUUID() {
            const cookie = document.cookie
            .split('; ')
            .find(row => row.startsWith('OptanonConsent='));
            if (!consentCookie) return 'no-uuid';

            // The OptanonConsent cookie is URL-encoded; parse out the consentID param
            const decoded = decodeURLcomponent(cookie);
            const match = decoded.match(/consentID=([^&]+)/);
            return match ? match[1] : 'no-uuid';
        }

        function getOptanonCookie() {
            const raw = document.cookie
            .split('; ')
            .find(row => row.startsWith('OptanonConsent='));
            return raw ?decodeURIComponent(raw) : "Not found";
        }

        function updateResults(title, data) {
            const container = document.getElementById('results');
            container.innerHTML = `<h3>${title}</h3><pre>${JSON.stringify(data,null,2)}</pre>`;
        }
        function showUUID() {
            const uuid = getConsentUUID();
            const cookieVal = getOptanonCookie();
            updateResults("Anonymous Consent UUID & OptanonConsentCookie", { uuid: uuid || "Not found" , cookie: cookieVal});
            console.log("Anonymous UUID:", uuid, "OptanonConsent cookie:", cookieVal);
        }

        function showActiveGroups() {
            updateResults("Active Cookie Categories", { activeGroups: OptanonActiveGroups || "Not loaded"});
            console.log("Active Groups:", OptanonActiveGroups);
        }
        // async function fetchUUIDPreferences() {
        //     const uuid = getConsentUUID();
        //     if(!uuid) {
        //         updateResults("Error", { message: "No OptanonConsent cookie found" });
        //     }

        //     const resp = await fetch('/api/fetch-preferences', {
        //         method: 'POST',
        //         headers: { 'Content-Type': 'application/json'},
        //         body: JSON.stringify({ uuid, token: HARDCODED_JWT})
        //     });
        //     const data = await resp.json();
        //     updateResults(`Preferences for UUID: ${uuid}`, data);
        // }

        // Simulate login: link the anonymous UUID to a fake user
        function simulateLogin() {
            const uuid = getConsentUUID();
            updateResults("Before Linking", { uuid });

            // Link this session (anonymous UUID) to a datasubject using jwt
            console.log("Logging in and linking to 123456789...")

            OneTrust.SetUserId(user_id, { token: HARDCODED_JWT });

            setTimeout(() => {
                updateResults("After Linking" , { uuid, linkedTo: user_id });
                console.log("Linked UUID", uuid, "to Data Subject", user_id);

                // placeholder: full preferences API added later

                console.log("To fetch full preferences, we will call the OneTrust API via backend later.");
            }, 2000);
        }

         // example: only set a test cookie if user consented to Performance (C0002)
        function dropTestCookie() {
            if (OptanonActiveGroups && OptanonActiveGroups.indexOf('C0002') > -1) {
                document.cookie ='test_cookie=allowed; path=/;';
                updateResults("Test Cookie", { status: "Set (Performance consent granted)" });
            } else {
                updateResults("Test Cookie", { status: "Blocked (no Performance consent granted)" });
            }
        }

        // Open the OneTrust preference center
        function openPreferenceCenter() {
            if (typeof OneTrust != 'undefined') {
                OneTrust.ToggleInfoDisplay();
            } else {
                alert("OneTrust not loaded yet.")
            }
        }
    </script>
</body>
</html>